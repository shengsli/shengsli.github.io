<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-04-11 Sat 17:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ppls lec06 review</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" 						   type="text/css" 						   href="/css/style.css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">ppls lec06 review</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgac38590">1. Barriers (a synchronization primitive)</a></li>
<li><a href="#org26e6757">2. Counter barriers (centralized)</a>
<ul>
<li><a href="#org127ab73">2.1. version 1 (correct): non-reusable</a></li>
<li><a href="#org74a2a5b">2.2. version 2 (wrong): 1st attempt to reuse</a></li>
<li><a href="#org6109764">2.3. version 3 (correct): <b>sense reversing barrier</b>, 2nd attempt to reuse</a></li>
</ul>
</li>
<li><a href="#org738a288">3. Symmetric barriers (decentralized)</a>
<ul>
<li><a href="#orgd7063d9">3.1. butterfly pattern/barrier</a>
<ul>
<li><a href="#orgc5b67f5">3.1.1. implementation</a></li>
</ul>
</li>
<li><a href="#orgce680bd">3.2. dissemination barriers: solve constraint on # threads is power of 2</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgac38590" class="outline-2">
<h2 id="orgac38590"><span class="section-number-2">1</span> Barriers (a synchronization primitive)</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>general idea: 
<ul class="org-ul">
<li>we have points in code that we want to ensure that all threads reach that point before any of them process beyond it.</li>
</ul></li>
<li>e.g. Jacobi interactive program has many barriers
<ul class="org-ul">
<li>protect shared multi-dimensional array</li>
<li>protect updates and reads from convergence testing variable</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org26e6757" class="outline-2">
<h2 id="org26e6757"><span class="section-number-2">2</span> Counter barriers (centralized)</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org127ab73" class="outline-3">
<h3 id="org127ab73"><span class="section-number-3">2.1</span> version 1 (correct): non-reusable</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>not reusable: once count become n, cannot be reset.</li>
</ul>
<pre class="example">
shared int count = 0;
co [i=1 to n] {
  do some work;
  ## now the barrier
  &lt;count = count + 1;&gt;
  &lt;await (count == n);&gt;
}
</pre>
</div>
</div>
<div id="outline-container-org74a2a5b" class="outline-3">
<h3 id="org74a2a5b"><span class="section-number-3">2.2</span> version 2 (wrong): 1st attempt to reuse</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>All threads will stuck. It will stop permanently.</li>
</ul>
<pre class="example">
shared int count = 0;
co [i=1 to n] {
  while (something) {    ## NB looping now
    do some work;
    ## now the barrier
    &lt;count = count + 1;&gt;
    &lt;await (count == n); count = 0;&gt;
  }
}
</pre>

<ul class="org-ul">
<li><b>Remarks</b>: Implementing barrier is a very tricky problem. Most variants are likely to fail.</li>
</ul>
</div>
</div>
<div id="outline-container-org6109764" class="outline-3">
<h3 id="org6109764"><span class="section-number-3">2.3</span> version 3 (correct): <b>sense reversing barrier</b>, 2nd attempt to reuse</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>core of the idea:
<ul class="org-ul">
<li>2 pieces of data (2 counters) control the behaviours of barriers</li>
<li>2nd data deals with signalling, 
<ul class="org-ul">
<li>It signals the barrier is now completed and you can carry on processing.</li>
</ul></li>
<li>why it is named sense reversing barrier?
<ul class="org-ul">
<li>because the shared variable <code>sense</code></li>
<li>the first time green signals that all threads may proceed, red signals keep waiting.</li>
<li>the second time is the opposite.</li>
</ul></li>
</ul></li>
</ul>
<pre class="example">
shared in count = 0; shared boolean sense = false;
co [i=1 to n] {
  private boolean mySense = !sense;  ## one per thread
  while (something) {
    do some work;
    &lt; count = count + 1;
      if (count == n) { count = 0; sense = mySense; }
    &gt;
    while (sense != mySense);        ## wait
    mySense = !mySense;
  }
}
</pre>
<ul class="org-ul">
<li>QnA: 
<ul class="org-ul">
<li>atomic section can be a bottleneck</li>
<li>writing to shared data can potentially affect cache coherence.</li>
</ul></li>
<li>Remarks: p71
<ul class="org-ul">
<li>The key idea is that we have separated the signal that the barrier has been completed (flipping sense) from the mechanism used to determine this condition, count. There is no longer an inter-iteration race between these two issue.</li>
<li>flipping the binary sense value simultaneously drops the barrier for one iteration while raising it for the next.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org738a288" class="outline-2">
<h2 id="org738a288"><span class="section-number-2">3</span> Symmetric barriers (decentralized)</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgd7063d9" class="outline-3">
<h3 id="orgd7063d9"><span class="section-number-3">3.1</span> butterfly pattern/barrier</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>designed to avoid the bottleneck at the critical section (counter).</li>
<li>butterfly pattern requires a power of 2 workers.</li>
<li>2 threads perform a local pairwise synchronization.</li>
<li>\(log(n)\) steps/stages. Each step/stage has constant number of things to be done.</li>
</ul>
</div>
<div id="outline-container-orgc5b67f5" class="outline-4">
<h4 id="orgc5b67f5"><span class="section-number-4">3.1.1</span> implementation</h4>
<div class="outline-text-4" id="text-3-1-1">
<pre class="example">
         1                                   n
        +---+---+---+---+---+---+---+---+---+---+
 arrive |0  |0  |0  |0  |0  |1  |0  |0  |0  |0  |
        +---+---+---+---+---+---+---+---+---+---+
</pre>
<ul class="org-ul">
<li>a worker has 2 things to do: 
<ol class="org-ol">
<li>set my own value to 1.</li>
<li>wait my partner's value set to 1.</li>
</ol></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="org6305baf"></a>version 1: prototype<br />
<div class="outline-text-5" id="text-3-1-1-1">
<pre class="example">
&lt;await (arrive[myid] == 0);&gt;
arrive[myid] = 1;
&lt;await (arrive[friend] == 1;&gt;
arrive[friend] = 0;
</pre>
<ul class="org-ul">
<li>The core of code is 2 lines in the middle.</li>
<li>The other 2 lines (the first and last statement) are to do with  cleaning things up for an other iteration later on.</li>
<li>The first line avoids race problems caused by previous uses of the barrier.</li>
<li>However, when used as a step within a multi-stage symmetric barrier, there is an additional problem.
<ul class="org-ul">
<li><p>
p74
</p>
<pre class="example">
for [s = 0 to stages-1] {
  &lt;await (arrive[myid] = 1;&gt;
  arrive[myid] = 1;
  work out who my friend is at stage s;
  &lt;await (arrive[friend] == 1);&gt;
  arrive[friend] = 0;  
}
</pre></li>
<li class="off"><code>[&#xa0;]</code> review again</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org695a97c"></a>version 2: fixed<br />
<div class="outline-text-5" id="text-3-1-1-2">
<pre class="example">
for [s = o to stages-1] { ## there will be log_2 p stages
  &lt;await (arrive[myid][s] == o);&gt;
  arrive[myid][s] = 1;
  work out who my friend is at this stage;
  &lt;await (arrive[myid][s] == 1);&gt;
  arrive[friend][s] = 0;
}
</pre>
<ul class="org-ul">
<li>QnA
<ul class="org-ul">
<li>How friends are calculated?
<ul class="org-ul">
<li>friend id = \((myid + 2^{(stage-1)) mod P}\), stage starts from 1, P is number of threads</li>
</ul></li>
</ul></li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-orgce680bd" class="outline-3">
<h3 id="orgce680bd"><span class="section-number-3">3.2</span> dissemination barriers: solve constraint on # threads is power of 2</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>A thread tells one thread that I will arrive, and waits one thread to arrive. 
<ul class="org-ul">
<li>i.e. who am I waiting for and who am I signalling to?</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
</body>
</html>
